### 一、项目一：C语言本质

1. 变量初始化以及存储（全局变量和局部变量）----**栈操作：向上，向下，先减在操作，先操作再减**-----此处采用先调整指针位置，再操作， 向下增长

   - 局部变量：存储位置和生命周期（全局变量位于RAM前部，栈位于RAM尾部，向下减小）首先从高地址向下进行压栈，之后就是局部变量地址
     - 局部变量地址：**首先从高地址向下进行压栈（LR寄存器以及传参寄存器值），之后就是局部变量地址**
     - 局部变量初始化：**通过MOV指令**，将一个立即数存入寄存器，再将寄存器放入栈顶值（通过一个寄存器占坑，存入R3寄存器）
     - 局部数组初始化：将SP指针减去数组大小（数组空间初始化），
     - 局部变量释放：函数执行完，要返回的时候执行pop指令，栈空间被释放，
       - push和pop操作：入栈压栈：Lr等寄存器，出栈： 低地址存进低标号寄存器	
   - 全局变量和局部静态变量（极端情况：非常巨大的全局变量初始化怎么操作）：
     - 全局变量、static变量初始化：由编译器进行初始化，并将数据放在flash的data段，在程序bl main函数之前，调用copy函数，将全局变量拷贝到RAM对应的地址（BL Copy：copy函数由调用者实现）
     - 全局变量、static变量存储：RAM开始的地址（小地址--一般是2000、0000，因为ram段开始地址就是20000000，按照顺序进行全局变量排序，栈空间对应大地址向下增长），初始化的变量存储在Flash的data段
     - 全局变量、static变量为0的情况（BSS段）：执行memset，将这一段内存清零
     -  <img src="J:\Git-Space\Typora\image-20240213234004734.png" alt="image-20240213234004734"  />
     - 拷贝对应的全局变量值以及无初始化和初始化为0的值

2. 堆栈：

   - 栈大小：寻找使用局部变量最多的调用链，选出空闲空间作为栈大小

   - ```
     char *str;
     str = malloc(100);
     ```

   - 对于堆栈原理:

     - 首先进行lr入栈，之后就是局部变量入栈，
     - <img src="J:\Git-Space\Typora\image-20240214105509680.png" alt="image-20240214105509680" style="zoom:50%;" />
     - 对于push操作，就要进行一次写内存，消耗时间，对char a，char name[100]，这样的连续分配，系统直接分配104个内存，sp-104，写一次内存，编译原理

   - 堆栈空间：也可以采用一块巨大的buffer，freertos使用方法

3. 函数：

   - 有趣的实验：

     - 首先定义一个函数，定义函数指针，将函数指令长度（16字节长度）拷贝到某一个区域，然后执行跳转

     - 有可能发生的情况：F103中函数使用的是Thumb指令集，原有的地址上加了1，因此在拷贝的时候需要将最低位数据清零，拷贝到目标地址之后需要将**函数指针**重新加上1，按照Thumb执行程序 

     - ```
       int mymain()
       {
       	volatile int a = 1;	
       	int (*f)(int v);
       	
       	a = add_val(a);
       	
       	
       	
       	copy_add_val_to_ram();
       	
       	f = (int (*)(int v))0x20008001;
       	a = f(a);
       	
       	a = add_val(a);
       	
       	return 0;
       }
       ```

       

     - ```
       void copy_add_val_to_ram(void)
       {
       	unsigned char *src;
       	unsigned int val = (unsigned int)add_val;
       	unsigned char *dest = (unsigned char *)0x20008000;
       	
       	int i;
       	
       	src = (unsigned char *)(val & ~1);
       	
       	for (i = 0; i < 16; i++)
       	{
       		dest[i] = src[i];
       	}
       }
       ```

       

     - ```
       int add_val(int v)
       {
       	volatile  int a = v;
       	a++;
       	return a;
       }
       ```

   - 调用函数：让CPU的PC寄存器等于函数指针

   - 参数传递：通过R0等寄存器传递参数

   - 函数指针数据传递：通过寄存器进行函数参数值

4. 指针：

   - 指针是什么：指针（32位平台占据4个字节）
   
   - 32bit**数据初始化流程**
   
   - 字符串变量初始化：
   
     - ```
       char str[10] = "ABC";
       ```
   
     - 初始化流程：初始值保存在flash，初始化的时候拷贝到ram中，
   
   - 实例
   
     - ```
       struct person
       {
       	int age；
       	int sex;
       	struct person *half;
       }
       person xiaoming = {19,1,&xiaozhang};
       ```
   
     - 变量定义在ram空间中，但是初始化的值存在于flash中，在跳转到main函数之前，存在初始化动作，将初始化的具体值拷贝到ram对应的地址中。

### 二、项目必备的HAL库基础

### 三、AT指令

### 四、基于HAL实现智能家居

1. 框架设计
   - 第1层：软件系统，就是整个系统、整个程序
   - 第2层：分解为子系统或包。比如我们可以拆分为：输入子系统、显示子系统、业务系统
   - 第3层：分解为类。在C语言里没有类，可以使用结构体来描述子系统。
   - 第4层：分解成子程序：实现那些结构体(结构体中有函数指针)。

2. 输入子系统：
   - 按键、网络、标准IO、

3. 测试系统：
   - 构造Input_test.c：函数中只需要添加设备，然后初始化设备，
   - ![02_software_block](J:\Git-Space\Typora\02_software_block-1708261006186-1.png)
   - 输入事件通过中断，写入到环形缓冲区中，等待读取，




































































